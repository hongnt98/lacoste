import{delegate as t,replaceAll as e,mergeDeep as a,buildSingleton as r}from"./croco.js";const n=400;class i{constructor(){this.datalayer=window.utag_data||{},this.tagPlan={},this.trackBuffer=[],this.bindEvents(),this.isScriptLoaded()?this.onScriptLoad():this.loadScript()}updateTagPlan(t,a){a&&(t=JSON.parse(e(JSON.stringify(t),a))),this.tagPlan=Object.assign(this.tagPlan,t)}retrieveTag(t){let e=null,a=t.split(".");return 2===a.length&&this.tagPlan[a[0]]&&this.tagPlan[a[0]][a[1]]&&(e=this.tagPlan[a[0]][a[1]]),e}updateDatalayer(t,e){t&&e&&(this.datalayer[t]=e),window.utag_data=this.datalayer}isScriptLoaded(){return window.Bootstrapper&&"object"==typeof window.Bootstrapper.ensEvent&&"function"==typeof window.Bootstrapper.ensEvent.trigger}onScriptLoad(){this.emptyBuffer()}loadScript(){const t=document.createElement("script");t.onload=this.onScriptLoad.bind(this),t.src="https://nexus.ensighten.com/lacoste/privacy/Bootstrap.js",document.getElementsByTagName("head")[0].appendChild(t)}emptyBuffer(){if(this.isScriptLoaded())for(let t=0,e=this.trackBuffer.length;t<e;t++)window.Bootstrapper.ensEvent.trigger(this.trackBuffer[t].eventName,this.trackBuffer[t].datalayer)}bindEvents(){t(document.documentElement,".js-track","click",this.onTrackClick.bind(this))}onTrackClick(t){let e=t.target;const a=e.href,r=e.target,i=e.dataset.tagId,s=e.dataset.replace?JSON.parse(e.dataset.replace):null,o=!e.dataset.noRedirect;!r&&a&&o&&t.preventDefault(),this.sendTracking(i,s),!r&&a&&o&&setTimeout(function(){document.location=a},n)}sendTracking(t,r){let n=this.retrieveTag(t);if(n){r&&(n=JSON.parse(e(JSON.stringify(n),r)));let t=a(this.datalayer,n.data);this.updateDatalayer(),this.isScriptLoaded()?(this.emptyBuffer(),window.Bootstrapper.ensEvent.trigger(n.eventName,t),Lacoste.siteprefs.IS_DEV_MODE&&console.log("%c[event-tracker -> sendTracking] tracking:","color: DeepPink;",n.eventName,t)):this.trackBuffer.push({eventName:n.eventName,datalayer:t})}else console.warn("[event-tracker -> sendTracking] tagId undefined or unknown:",t)}}export const Tracker=r("etr",new i);